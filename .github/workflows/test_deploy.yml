name: Test_Deploy

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.15.0'

    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm install
        echo "Dependencies installed."

    - name: Run tests
      run: |
        npm test
        echo "Tests completed."

  deploy:
    runs-on: ubuntu-latest
    needs: test    
    if: success()  
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      run: |
        # Define the target directory and application zip file
        TARGET_DIR="/home/ubuntu/my-app"
        APP_ZIP="my-app.zip"

        # Create the target directory if it doesn't exist
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p $TARGET_DIR"

        # Zip the application code, excluding .git directory
        zip -r $APP_ZIP . -x "*.git*"

        # Copy the zip file to EC2
        scp -o StrictHostKeyChecking=no $APP_ZIP ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$TARGET_DIR

        # SSH into EC2 and deploy
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        cd $TARGET_DIR
        unzip -o my-app.zip
        npm install
        pm2 restart my-app || pm2 start app.js --name my-app
        rm my-app.zip
        EOF
